<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Opencode Uptime Monitor</title>
  <style>body{font-family:Arial,sans-serif;max-width:900px;margin:2rem auto;padding:1rem} label{display:block;margin-top:1rem} input,button,textarea{padding:.5rem;width:100%}</style>
</head>
<body>
  <h1>Opencode Uptime Monitor (MVP)</h1>
  <section>
    <h2>Top up (simulated)</h2>
    <label>Sats<input id="sats" value="100"></label>
    <button id="do-topup">Top up & get token</button>
    <pre id="topout"></pre>
  </section>
  <section>
    <h2>Register a target</h2>
    <label>URL<input id="url" placeholder="https://example.com"></label>
    <label>Interval (seconds)<input id="interval" value="60"></label>
    <button id="register">Register</button>
    <pre id="regout"></pre>
    <div id="regsuccess" style="color:green"></div>
  </section>
  <section>
    <h2>Your dashboard</h2>
    <div id="dash"></div>
  </section>
  <section>
    <h2>Targets</h2>
    <button id="list">Refresh list</button>
    <pre id="listout"></pre>
  </section>
<script>
const apiBase = '';
function qs(name){
  const m=new URLSearchParams(window.location.search);
  return m.get(name);
}
function saveToken(t){ localStorage.setItem('opencode_token', t); }
function loadToken(){ return qs('token') || localStorage.getItem('opencode_token'); }

// topup -> create session token
document.getElementById('do-topup').onclick=async()=>{
  const sats=parseInt(document.getElementById('sats').value||100);
  const resp=await fetch('/topup',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({sats})});
  const j=await resp.json();
  document.getElementById('topout').textContent=JSON.stringify(j,null,2);
  if(j.token){ saveToken(j.token); window.location.href = '/d/' + j.token; }
}

// register uses token
document.getElementById('register').onclick=async()=>{
  const token = loadToken();
  if(!token){ alert('No session token; please topup first'); return }
  const url=document.getElementById('url').value, interval=parseInt(document.getElementById('interval').value||60);
  const resp=await fetch('/register',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({token,url,interval})});
  const data=await resp.json();
  document.getElementById('regout').textContent=JSON.stringify(data,null,2);
  if(resp.status==200){ document.getElementById('regsuccess').textContent='Registered!'; loadDashboard(); }
}

// list all canonical targets
document.getElementById('list').onclick=async()=>{
  const resp=await fetch('/targets'); const data=await resp.json(); document.getElementById('listout').textContent=JSON.stringify(data,null,2);
}

async function loadDashboard(){
  const token=loadToken();
  if(!token){ document.getElementById('dash').innerHTML='<p>No token. Please topup.</p>'; return }
  const resp=await fetch('/d/'+token);
  if(resp.status!=200){ document.getElementById('dash').innerHTML='<p>Session not found</p>'; return }
  const j=await resp.json();
  let html=`<p>Token: ${j.session.token} — credits: ${j.session.credits}</p>`;
  if(j.watchers.length==0) html += '<p>No watchers yet</p>';
  for(const w of j.watchers){
    html += `<div style="border:1px solid #ddd;padding:.5rem;margin:.5rem 0"><strong>${w.url}</strong> interval ${w.interval}s — credits usage placeholder<br><button onclick="viewWatcher('${w.wid}')">View history</button><pre id="hist-${w.wid}"></pre></div>`
  }
  document.getElementById('dash').innerHTML=html;
}

async function viewWatcher(wid){
  const token=loadToken();
  const resp=await fetch(`/reports/wid/${token}/${wid}`);
  const j=await resp.json();
  document.getElementById('hist-'+wid).textContent = JSON.stringify(j,null,2);
}

// on load
loadDashboard();
</script>
</body>
</html>
